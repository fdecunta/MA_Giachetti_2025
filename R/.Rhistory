library(tidyverse)
raw_data <- read_csv("../data/Giachetti_2025_raw.csv", show_col_types = FALSE) %>%
janitor::clean_names()
glimpse(raw_data)
print("Rows removed: ")
raw_data %>%
filter(nurse_species == "unknown" | nurse_species == "various") %>%
nrow()
# Only 7 observations were removed
raw_data <- raw_data %>%
filter(nurse_species != "unknown", nurse_species != "various")
## -------------------------------- ##
## Relative Interaction Index (RII) ##
## -------------------------------- ##
# Compute the Relative Interaction Index (RII) and its sampling variance.
# The formulas are based on Armas et al. (2004), Appendix A:
# https://esapubs.org/archive/ecol/E085/082/appendix-A.htm
rii_mean <- function(m1i, m2i) {
(m1i - m2i) / (m1i + m2i)
}
rii_var <- function(m1i, sd1i, n1i, m2i, sd2i, n2i) {
var1 <- sd1i^2
var2 <- sd2i^2
ro <- (var1 / n1i - var2 / n2i) / (var1 / n1i + var2 / n2i)
((var1 / n1i) + (var2 / n2i)) / ((m1i + m2i)^2) *
(1 + (((m1i - m2i)^2) / ((m1i + m2i)^2)) + ((2 * ro * (m1i - m2i)) / (m1i + m2i)))
}
## -------------------------------- ##
## Relative Interaction Index (RII) ##
## -------------------------------- ##
# Compute the Relative Interaction Index (RII) and its sampling variance.
# The formulas are based on Armas et al. (2004), Appendix A:
# https://esapubs.org/archive/ecol/E085/082/appendix-A.htm
rii_mean <- function(m1i, m2i) {
(m1i - m2i) / (m1i + m2i)
}
rii_var <- function(m1i, sd1i, n1i, m2i, sd2i, n2i) {
var1 <- sd1i^2
var2 <- sd2i^2
ro <- (var1 / n1i - var2 / n2i) / (var1 / n1i + var2 / n2i)
((var1 / n1i) + (var2 / n2i)) / ((m1i + m2i)^2) *
(1 + (((m1i - m2i)^2) / ((m1i + m2i)^2)) + ((2 * ro * (m1i - m2i)) / (m1i + m2i)))
}
## ---------------------- ##
## Arcsine Transformation ##
## ---------------------- ##
# Some variables are proportions, so we transform them
# prior to calculating the RII.
# We compute the arcsine transformation for the mean
# and calculate the associated variance using the formulas
# described by Macartney et al. (2022).
# References:
# - Macartney, Lagisz, & Nakagawa (2022): https://doi.org/10.1016/j.neubiorev.2022.104554
asin_transf <- function(x, sd) {
# Assumes x and sd are percentages
m <- x / 100
s <- sd / 100
t_mean <- asin(sqrt(m))
t_var <- (s^2) / (4 * m * (1 - m))
t_sd <- sqrt(t_var)
return(cbind(t_mean, t_sd))
}
# Calculate RII for the data without arcsine transformation
RII_data <- raw_data %>%
mutate(orig_RII = if_else(startsWith(variable, "rii"),
rii,
rii_mean(mean_island, mean_bs)),
orig_RIIV = if_else(startsWith(variable, "rii"),
sd_rii,
rii_var(mean_island,
sd_island,
n_island,
mean_bs,
sd_bs,
n_bs)))
# Calculate RII for the data with arcsine transformation
# ACA EL PROBLEMA ES QUE TRANSFORMA USANDO EL VALOR TRANSFORMADO!!!
RII_data <- RII_data %>%
mutate(
# Transform from proportion to percentage before apply arcsin
mean_island = if_else(unidad == "proportion", mean_island * 100, mean_island),
sd_island = if_else(unidad == "proportion", sd_island * 100, sd_island),
mean_bs = if_else(unidad == "proportion", mean_bs * 100, mean_bs),
sd_bs = if_else(unidad == "proportion", sd_bs * 100, sd_bs),
unidad = if_else(unidad == "proportion", "%", unidad))
# Apply arcsine transformation
transf_island <- with(RII_data, asin_transf(mean_island, sd_island))
transf_bs <- with(RII_data, asin_transf(mean_bs, sd_bs))
# Add transformed values to the data
RII_data <- RII_data %>%
mutate(
mean_island = if_else(unidad == "%",
transf_island[ , 1],
mean_island),
sd_island = if_else(unidad == "%",
transf_island[ , 2],
sd_island),
mean_bs = if_else(unidad == "%",
transf_bs[ , 1],
mean_bs),
sd_island = if_else(unidad == "%",
transf_bs[ , 2],
sd_bs))
# Calculate RII
RII_data <- RII_data %>%
mutate(RII = if_else(startsWith(variable, "rii"),
rii,
rii_mean(mean_island, mean_bs)),
RIIV = if_else(startsWith(variable, "rii"),
sd_rii,
rii_var(mean_island,
sd_island,
n_island,
mean_bs,
sd_bs,
n_bs)))
RII_data <- RII_data %>%
mutate(nit.RII = rii_mean(mean_island_nit, mean_bs_nit),
nit.RIIV = rii_var(mean_island_nit, sd_island_nit, n_island_fi, mean_bs_nit, sd_bs_nit, n_bs_fi),
p.RII = rii_mean(mean_island_p, mean_bs_p),
p.RIIV = rii_var(mean_island_p, sd_island_p, n_island_fi, mean_bs_p, sd_bs_p, n_bs_fi))
RII_data <- RII_data %>%
select(-c(variable, unidad, rii, sd_rii, mean_island, sd_island, n_island, mean_bs, sd_bs, n_bs, mean_island_nit, sd_island_nit, n_island_fi, mean_bs_nit, sd_bs_nit, n_bs_fi, mean_island_p, sd_island_p, mean_bs_p, sd_bs_p, n_island_fi, n_bs_fi))
write_csv(RII_data, "../data/Giachetti_2025_processed.csv")
